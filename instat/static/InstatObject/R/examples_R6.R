rm(list=ls())
setwd("C:/Users/Danny/Source/Repos/Instat_Danny/instat/static/InstatObject/R")
source("Rsetup.R")
survey <- read.csv("C:/Users/Danny/Downloads/survey.csv")
InstatDataObject <- instat_object$new()
InstatDataObject$import_data(data_tables = list(survey, survey))
# InstatDataObject <- instat_object$new()
# # dlgImportDataset code generated by the dialog Import Dataset
#new_RDS <- readRDS(file="C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/tomato and survey.RDS")
#sudan <- import("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/hh_Module2_CLEAN.xlsx")
#InstatDataObject$import_data(data_tables = list(sudan=sudan))
# InstatDataObject$delete_dataframe(data_name ="survey")
# InstatDataObject$delete_dataframe(data_name ="SAMRAIN")
# # dlgImportDataset code generated by the dialog Import Dataset
# new_RDS <- readRDS(file="C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/_survey_SAMRAIN.RDS")
# InstatDataObject$import_RDS(data_RDS=new_RDS, include_filters=FALSE)
# InstatDataObject$get_data_frame()

#hh <- rio::import(file="C:/Users/Danny/Downloads/hh_70.csv")
#InstatDataObject$import_data(data_tables = list(hh=hh))

# dlgImportDatasetcode generated by the dialogImport Dataset
survey <- read.csv(file="C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/survey.csv",header=TRUE)
SAMARU56 <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/SAMARU56.csv")
dodoma <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/Dodomamx.dat.csv")
long1 <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/long2edit.csv")
butare <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/butaretemp.csv")
ydoy <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/y-doy.csv")

#Peru <- rio::import(file="C:/Users/Danny/Downloads/Resumen Datos 3 paises.xlsx", which = 2)
#barrow <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/Barrow_subdaily.csv")
#survey=survey[survey$Village.=="SABEY",]

#InstatDataObject$import_from_ODK("ami", "ami", "kitale arrival survey")

#InstatDataObject$import_data(data_tables = list(survey=survey, SAMARU56 = SAMARU56, butare = butare, ydoy = ydoy))

# Multiple level data example
# Yearly <- data.frame(Year = 2000:2010, El = rep(c("A", "B", "C"), length.out = 11))
# Daily <- data.frame(Rain = rnorm(100), Year = rep(2000:2010, length.out = 100))
# InstatDataObject$import_data(data_tables = list(Yearly=Yearly, Daily = Daily))
# El_group <- instat_calculation$new(type = "by", calculated_from = list(Yearly = "El"))
# mean_summary <- instat_calculation$new(function_exp = "mean(Rain)", type = "summary", result_name = "mean_Rain", save_output = FALSE,
#                                        calculated_from = list(Daily = "Rain"), manipulations = list(El_group))
# 
# output <- InstatDataObject$apply_instat_calculation(mean_summary)

#InstatDataObject <- NULL
Daily <- read.csv("C:/Users/Danny/Downloads/Bungoma_edit.csv", na.strings = "-9998")
Monthly <- Daily %>% group_by(Year, Month) %>% summarise(Av_Rain = mean(Rain))
InstatDataObject$import_data(data_tables = list(Monthly = Monthly, Daily = Daily))

Year_group_for_daily <- instat_calculation$new(type = "by", calculated_from = list(Daily = "Year"))
Year_group_for_monthly <- instat_calculation$new(type = "by", calculated_from = list(Monthly = "Year"))
mean_rain_from_daily <- instat_calculation$new(function_exp = "mean(Rain)", type = "summary", result_name = "mean_Rain_daily",
                                               calculated_from = list(Daily = "Rain"))
mean_rain_from_monthly <- instat_calculation$new(function_exp = "mean(Av_Rain)", type = "summary", result_name = "mean_Rain_monthly",
                                               calculated_from = list(Monthly = "Av_Rain"))
Yearly_diff <- instat_calculation$new(function_exp = "abs(mean_Rain_daily - mean_Rain_monthly)", type = "calculation", result_name = "diff",
                                      sub_calculations = list(mean_rain_from_daily, mean_rain_from_monthly), manipulations = list(Year_group_for_daily))
full_join(Daily, Monthly, by = c(Year, Month = Month))
InstatDataObject$apply_instat_calculation(Yearly_diff)

# 1. proportions example
village_group <- instat_calculation$new(type = "by", calculated_from = list(survey = "Village."))
total <- instat_calculation$new(function_exp = "n()", type = "summary", result_name = "total", save_output = TRUE)
variety_group <- instat_calculation$new(type = "by", calculated_from = list(survey = "Variety."))
val <- instat_calculation$new(function_exp = "n()", type = "summary", result_name = "val",
                              manipulations = list(variety_group), save_output = TRUE)
#TODO what should data frame name be for calculated_from "val" and "total"? Needed to add metadata correctly
prop_calc <- instat_calculation$new(function_exp = "val/total", type = "calculation", calculated_from = list(survey = "val", survey = "total"), 
                                    result_name = "prop", manipulations = list(village_group),
                                    sub_calculations = list(total, val), save_output = TRUE, name = "prop_calc")
x<-InstatDataObject$apply_instat_calculation(prop_calc)
#InstatDataObject$get_data_names()
#InstatDataObject$get_data_frame("survey_by_Village._Variety.")

# 2. calculation with sub calculations example
Yield2 <- instat_calculation$new(function_exp = "Yield * 2", type = "calculation", result_name = "Yield2", calculated_from = list(survey = "Yield"), save_output = FALSE)
Yield3 <- instat_calculation$new(function_exp = "Yield * 3", type = "calculation", result_name = "Yield3", calculated_from = list(survey = "Yield"), save_output = FALSE)
Yield_com <- instat_calculation$new(type = "calculation", function_exp = "Yield3 - Yield2", calculated_from = list(survey = "Yield2", survey = "Yield3"),
                                    sub_calculations = list(Yield2, Yield3), save_output = TRUE, result_name = "YieldCheck", save_calc = FALSE)
x<-InstatDataObject$apply_instat_calculation(Yield_com)
#InstatDataObject$get_data_frame("survey")

# 3. empty calculation with two sub calculations using different filters, can be done if data has a key
# (output comes in stange order but added to data correctly)
InstatDataObject$add_columns_to_data("survey", col_data = 1:36, col_name = "ID")
InstatDataObject$add_key("survey", "ID")
Yield_over_50 <- instat_calculation$new(type = "filter", function_exp = "Yield > 50", calculated_from = list(survey = "Yield"))
Yield_under_50 <- instat_calculation$new(type = "filter", function_exp = "Yield <= 50", calculated_from = list(survey = "Yield"))

sub1 <- instat_calculation$new(function_exp = "Yield * Size", type = "calculation", result_name = "YieldxSize", manipulations = list(Yield_over_50), calculated_from = list(survey = "Yield"), save_output = TRUE)
sub2 <- instat_calculation$new(function_exp = "Yield * 100", type = "calculation", result_name = "Yieldx100", manipulations = list(Yield_under_50), calculated_from = list(survey = "Yield"), save_output = TRUE)

Yield_Size_com <- instat_calculation$new(type = "combination", manipulations = list(), sub_calculations = list(sub1, sub2), save_output = TRUE)
x<-InstatDataObject$apply_instat_calculation(Yield_Size_com)

#InstatDataObject$get_data_names()
#InstatDataObject$get_data_frame("survey_by_Village._Variety.")
#InstatDataObject$get_data_frame("survey")

#saveRDS(InstatDataObject, "SAMARU56.RDS")
InstatDataObject$import_data(data_tables = list(survey = survey))
InstatDataObject$import_RDS(InstatDataObject2, 
                            keep_existing = TRUE,
                            overwrite_existing = TRUE,
                            include_objects = TRUE, 
                            include_metadata = TRUE, 
                            include_logs = TRUE, 
                            include_filters = TRUE, 
                            include_calculations = TRUE)
InstatDataObject$get_data_names()
InstatDataObject$get_variables_metadata("survey")
#InstatDataObject$insert_row_in_data("survey", start_row = 10, number_rows = 1, before = TRUE)
x <- c("StartDate","StartTime","EndDate","EndTime","deviceid","data_collector","community_id","school","farm_id","hh_ID","house_type","other_house_type","GPS_coordinates","X_GPS_coordinates_latitude","X_GPS_coordinates_longitude","X_GPS_coordinates_altitude","X_GPS_coordinates_precision","acknowledge","groupings_1.informant_type","groupings_1.other_informant","groupings_1.groupings_2.age_household","groupings_1.groupings_2.polygamy_elsewhere_farms","groupings_1.groupings_14.household_units","groupings_1.groupings_14.household_members","groupings_1.groupings_3.education_primary","groupings_1.groupings_3.education_secondary","groupings_1.groupings_3.education_higher","groupings_1.groupings_4.post_higher_education","groupings_1.groupings_4.jobless_higher_education","groupings_1.groupings_4.unmarried_daughters_with_kids","groupings_1.active_languages_spoken","groupings_1.active_languages_spoken.english","groupings_1.active_languages_spoken.kiswahili","groupings_1.active_languages_spoken.luhya","groupings_1.active_languages_spoken.kalenjin","groupings_1.active_languages_spoken.kikuyu","groupings_1.active_languages_spoken.kisii","groupings_1.active_languages_spoken.turkana","groupings_1.active_languages_spoken.other","groupings_1.active_languages_spoken.consent_to_ask_not_given","groupings_1.other_language","groupings_1.land_size","groupings_1.groupings_5.crops_grown","groupings_1.groupings_5.crops_grown.none","groupings_1.groupings_5.crops_grown.maize","groupings_1.groupings_5.crops_grown.beans","groupings_1.groupings_5.crops_grown.sweet_potatoes","groupings_1.groupings_5.crops_grown.millet","groupings_1.groupings_5.crops_grown.sorghum","groupings_1.groupings_5.crops_grown.kales","groupings_1.groupings_5.crops_grown.tomatoes","groupings_1.groupings_5.crops_grown.onions",
       "groupings_1.groupings_5.crops_grown.cabbage","groupings_1.groupings_5.crops_grown.arrow_root","groupings_1.groupings_5.crops_grown.avocado","groupings_1.groupings_5.crops_grown.carrot","groupings_1.groupings_5.crops_grown.beetroot","groupings_1.groupings_5.crops_grown.eggplant","groupings_1.groupings_5.crops_grown.sugarcane","groupings_1.groupings_5.crops_grown.sunflower","groupings_1.groupings_5.crops_grown.wheat","groupings_1.groupings_5.crops_grown.irish_potatoe","groupings_1.groupings_5.crops_grown.chilly_pepper","groupings_1.groupings_5.crops_grown.cassava","groupings_1.groupings_5.crops_grown.amaranth","groupings_1.groupings_5.crops_grown.blacknightshade","groupings_1.groupings_5.crops_grown.cowpea","groupings_1.groupings_5.crops_grown.spider_plant","groupings_1.groupings_5.crops_grown.jute_mallow","groupings_1.groupings_5.crops_grown.banana","groupings_1.groupings_5.crops_grown.pumpkin","groupings_1.groupings_5.crops_grown.crotolaria","groupings_1.groupings_5.crops_grown.spinach","groupings_1.groupings_5.crops_grown.sweet_pepper","groupings_1.groupings_5.crops_grown.mango","groupings_1.groupings_5.crops_grown.passion_fruit","groupings_1.groupings_5.crops_grown.pawpaw","groupings_1.groupings_5.crops_grown.guava","groupings_1.groupings_5.crops_grown.dolichos","groupings_1.groupings_5.crops_grown.garden_pea","groupings_1.groupings_5.crops_grown.pigeon_pea","groupings_1.groupings_5.crops_grown.soya_bean","groupings_1.groupings_5.crops_grown.ground_nut","groupings_1.groupings_5.crops_grown.sesame","groupings_1.groupings_5.crops_grown.macadamia_nut","groupings_1.groupings_5.crops_grown.bambara_nut","groupings_1.groupings_5.crops_grown.water_melon","groupings_1.groupings_5.crops_grown.butternut","groupings_1.groupings_5.crops_grown.orange","groupings_1.groupings_5.crops_grown.custard_apple","groupings_1.groupings_5.crops_grown.pineapple","groupings_1.groupings_5.crops_grown.tree_tomato","groupings_1.groupings_5.crops_grown.gooseberry","groupings_1.groupings_5.crops_grown.jackfruit","groupings_1.groupings_5.crops_grown.nappier_grass","groupings_1.groupings_5.crops_grown.green_grams","groupings_1.groupings_5.crops_grown.loquats","groupings_1.groupings_5.crops_grown.red_climbing_spinach","groupings_1.groupings_5.crops_grown.white_sapote","groupings_1.groupings_5.crops_grown.other","groupings_1.groupings_5.crops_grown.consent_to_ask_not_given",
       "groupings_1.groupings_5.other_crops_grown","groupings_1.groupings_5.previous_crops","groupings_1.groupings_5.previous_crops.none","groupings_1.groupings_5.previous_crops.maize","groupings_1.groupings_5.previous_crops.beans","groupings_1.groupings_5.previous_crops.sweet_potatoes","groupings_1.groupings_5.previous_crops.millet","groupings_1.groupings_5.previous_crops.sorghum","groupings_1.groupings_5.previous_crops.kales","groupings_1.groupings_5.previous_crops.tomatoes","groupings_1.groupings_5.previous_crops.onions","groupings_1.groupings_5.previous_crops.cabbage","groupings_1.groupings_5.previous_crops.arrow_root","groupings_1.groupings_5.previous_crops.avocado","groupings_1.groupings_5.previous_crops.carrot","groupings_1.groupings_5.previous_crops.beetroot","groupings_1.groupings_5.previous_crops.eggplant","groupings_1.groupings_5.previous_crops.sugarcane","groupings_1.groupings_5.previous_crops.sunflower","groupings_1.groupings_5.previous_crops.wheat","groupings_1.groupings_5.previous_crops.irish_potatoe","groupings_1.groupings_5.previous_crops.chilly_pepper","groupings_1.groupings_5.previous_crops.cassava","groupings_1.groupings_5.previous_crops.amaranth","groupings_1.groupings_5.previous_crops.blacknightshade","groupings_1.groupings_5.previous_crops.cowpea","groupings_1.groupings_5.previous_crops.spider_plant","groupings_1.groupings_5.previous_crops.jute_mallow","groupings_1.groupings_5.previous_crops.banana","groupings_1.groupings_5.previous_crops.pumpkin","groupings_1.groupings_5.previous_crops.crotolaria","groupings_1.groupings_5.previous_crops.spinach","groupings_1.groupings_5.previous_crops.sweet_pepper","groupings_1.groupings_5.previous_crops.mango","groupings_1.groupings_5.previous_crops.passion_fruit","groupings_1.groupings_5.previous_crops.pawpaw","groupings_1.groupings_5.previous_crops.guava","groupings_1.groupings_5.previous_crops.dolichos","groupings_1.groupings_5.previous_crops.garden_pea","groupings_1.groupings_5.previous_crops.pigeon_pea","groupings_1.groupings_5.previous_crops.soya_bean","groupings_1.groupings_5.previous_crops.ground_nut","groupings_1.groupings_5.previous_crops.sesame","groupings_1.groupings_5.previous_crops.macadamia_nut","groupings_1.groupings_5.previous_crops.bambara_nut","groupings_1.groupings_5.previous_crops.water_melon","groupings_1.groupings_5.previous_crops.butternut","groupings_1.groupings_5.previous_crops.orange","groupings_1.groupings_5.previous_crops.custard_apple","groupings_1.groupings_5.previous_crops.pineapple","groupings_1.groupings_5.previous_crops.tree_tomato","groupings_1.groupings_5.previous_crops.gooseberry","groupings_1.groupings_5.previous_crops.jackfruit","groupings_1.groupings_5.previous_crops.nappier_grass","groupings_1.groupings_5.previous_crops.green_grams","groupings_1.groupings_5.previous_crops.loquats","groupings_1.groupings_5.previous_crops.red_climbing_spinach","groupings_1.groupings_5.previous_crops.white_sapote","groupings_1.groupings_5.previous_crops.other","groupings_1.groupings_5.previous_crops.consent_to_ask_not_given",
       "groupings_1.groupings_5.other_previous_crops","groupings_1.groupings_5.future_crops","groupings_1.groupings_5.future_crops.none","groupings_1.groupings_5.future_crops.maize","groupings_1.groupings_5.future_crops.beans","groupings_1.groupings_5.future_crops.sweet_potatoes","groupings_1.groupings_5.future_crops.millet","groupings_1.groupings_5.future_crops.sorghum","groupings_1.groupings_5.future_crops.kales","groupings_1.groupings_5.future_crops.tomatoes","groupings_1.groupings_5.future_crops.onions","groupings_1.groupings_5.future_crops.cabbage","groupings_1.groupings_5.future_crops.arrow_root","groupings_1.groupings_5.future_crops.avocado","groupings_1.groupings_5.future_crops.carrot","groupings_1.groupings_5.future_crops.beetroot","groupings_1.groupings_5.future_crops.eggplant","groupings_1.groupings_5.future_crops.sugarcane","groupings_1.groupings_5.future_crops.sunflower","groupings_1.groupings_5.future_crops.wheat","groupings_1.groupings_5.future_crops.irish_potatoe","groupings_1.groupings_5.future_crops.chilly_pepper","groupings_1.groupings_5.future_crops.cassava","groupings_1.groupings_5.future_crops.amaranth","groupings_1.groupings_5.future_crops.blacknightshade","groupings_1.groupings_5.future_crops.cowpea","groupings_1.groupings_5.future_crops.spider_plant","groupings_1.groupings_5.future_crops.jute_mallow","groupings_1.groupings_5.future_crops.banana","groupings_1.groupings_5.future_crops.pumpkin","groupings_1.groupings_5.future_crops.crotolaria","groupings_1.groupings_5.future_crops.spinach","groupings_1.groupings_5.future_crops.sweet_pepper","groupings_1.groupings_5.future_crops.mango","groupings_1.groupings_5.future_crops.passion_fruit","groupings_1.groupings_5.future_crops.pawpaw","groupings_1.groupings_5.future_crops.guava","groupings_1.groupings_5.future_crops.dolichos","groupings_1.groupings_5.future_crops.garden_pea","groupings_1.groupings_5.future_crops.pigeon_pea","groupings_1.groupings_5.future_crops.soya_bean","groupings_1.groupings_5.future_crops.ground_nut","groupings_1.groupings_5.future_crops.sesame","groupings_1.groupings_5.future_crops.macadamia_nut","groupings_1.groupings_5.future_crops.bambara_nut","groupings_1.groupings_5.future_crops.water_melon","groupings_1.groupings_5.future_crops.butternut","groupings_1.groupings_5.future_crops.orange","groupings_1.groupings_5.future_crops.custard_apple","groupings_1.groupings_5.future_crops.pineapple","groupings_1.groupings_5.future_crops.tree_tomato","groupings_1.groupings_5.future_crops.gooseberry","groupings_1.groupings_5.future_crops.jackfruit","groupings_1.groupings_5.future_crops.nappier_grass","groupings_1.groupings_5.future_crops.green_grams","groupings_1.groupings_5.future_crops.loquats","groupings_1.groupings_5.future_crops.red_climbing_spinach","groupings_1.groupings_5.future_crops.white_sapote","groupings_1.groupings_5.future_crops.other","groupings_1.groupings_5.future_crops.consent_to_ask_not_given","groupings_1.groupings_5.other_future_crops","groupings_1.groupings_5.crops_sold","groupings_1.groupings_5.crops_sold.none","groupings_1.groupings_5.crops_sold.maize","groupings_1.groupings_5.crops_sold.beans","groupings_1.groupings_5.crops_sold.sweet_potatoes","groupings_1.groupings_5.crops_sold.millet","groupings_1.groupings_5.crops_sold.sorghum","groupings_1.groupings_5.crops_sold.kales","groupings_1.groupings_5.crops_sold.tomatoes","groupings_1.groupings_5.crops_sold.onions","groupings_1.groupings_5.crops_sold.cabbage","groupings_1.groupings_5.crops_sold.arrow_root","groupings_1.groupings_5.crops_sold.avocado","groupings_1.groupings_5.crops_sold.carrot",
       "groupings_1.groupings_5.crops_sold.beetroot","groupings_1.groupings_5.crops_sold.eggplant","groupings_1.groupings_5.crops_sold.sugarcane","groupings_1.groupings_5.crops_sold.sunflower","groupings_1.groupings_5.crops_sold.wheat","groupings_1.groupings_5.crops_sold.irish_potatoe","groupings_1.groupings_5.crops_sold.chilly_pepper","groupings_1.groupings_5.crops_sold.cassava","groupings_1.groupings_5.crops_sold.amaranth","groupings_1.groupings_5.crops_sold.blacknightshade","groupings_1.groupings_5.crops_sold.cowpea","groupings_1.groupings_5.crops_sold.spider_plant","groupings_1.groupings_5.crops_sold.jute_mallow","groupings_1.groupings_5.crops_sold.banana","groupings_1.groupings_5.crops_sold.pumpkin","groupings_1.groupings_5.crops_sold.crotolaria","groupings_1.groupings_5.crops_sold.spinach","groupings_1.groupings_5.crops_sold.sweet_pepper","groupings_1.groupings_5.crops_sold.mango","groupings_1.groupings_5.crops_sold.passion_fruit","groupings_1.groupings_5.crops_sold.pawpaw","groupings_1.groupings_5.crops_sold.guava","groupings_1.groupings_5.crops_sold.dolichos","groupings_1.groupings_5.crops_sold.garden_pea","groupings_1.groupings_5.crops_sold.pigeon_pea","groupings_1.groupings_5.crops_sold.soya_bean","groupings_1.groupings_5.crops_sold.ground_nut","groupings_1.groupings_5.crops_sold.sesame","groupings_1.groupings_5.crops_sold.macadamia_nut","groupings_1.groupings_5.crops_sold.bambara_nut","groupings_1.groupings_5.crops_sold.water_melon","groupings_1.groupings_5.crops_sold.butternut","groupings_1.groupings_5.crops_sold.orange","groupings_1.groupings_5.crops_sold.custard_apple","groupings_1.groupings_5.crops_sold.pineapple","groupings_1.groupings_5.crops_sold.tree_tomato","groupings_1.groupings_5.crops_sold.gooseberry","groupings_1.groupings_5.crops_sold.jackfruit","groupings_1.groupings_5.crops_sold.nappier_grass","groupings_1.groupings_5.crops_sold.green_grams","groupings_1.groupings_5.crops_sold.loquats","groupings_1.groupings_5.crops_sold.red_climbing_spinach","groupings_1.groupings_5.crops_sold.white_sapote","groupings_1.groupings_5.crops_sold.other","groupings_1.groupings_5.crops_sold.consent_to_ask_not_given","groupings_1.groupings_5.other_crops_sold","groupings_1.groupings_5.groupings_6.crop_market_place","groupings_1.groupings_5.groupings_6.crop_market_place.neighbours","groupings_1.groupings_5.groupings_6.crop_market_place.middlemen","groupings_1.groupings_5.groupings_6.crop_market_place.contract_arrangement","groupings_1.groupings_5.groupings_6.crop_market_place.international","groupings_1.groupings_5.groupings_6.crop_market_place.regional","groupings_1.groupings_5.groupings_6.crop_market_place.nairobi","groupings_1.groupings_5.groupings_6.crop_market_place.kitale","groupings_1.groupings_5.groupings_6.crop_market_place.local","groupings_1.groupings_5.groupings_6.crop_market_place.consent_to_ask_not_given","groupings_1.groupings_5.groupings_6.other_crop_local_markets","groupings_1.groupings_5.groupings_6.groupings_7.crop_regular_income","groupings_1.groupings_5.groupings_6.groupings_7.crop_value_addition","groupings_1.groupings_8.livestock_kept","groupings_1.groupings_8.livestock_kept.none","groupings_1.groupings_8.livestock_kept.dairy_cattle","groupings_1.groupings_8.livestock_kept.oxen","groupings_1.groupings_8.livestock_kept.donkey","groupings_1.groupings_8.livestock_kept.poultry","groupings_1.groupings_8.livestock_kept.goats","groupings_1.groupings_8.livestock_kept.sheep","groupings_1.groupings_8.livestock_kept.fish","groupings_1.groupings_8.livestock_kept.bees","groupings_1.groupings_8.livestock_kept.pigs","groupings_1.groupings_8.livestock_kept.rabbits",
       "groupings_1.groupings_8.livestock_kept.quails","groupings_1.groupings_8.livestock_kept.ducks","groupings_1.groupings_8.livestock_kept.pigeon_doves","groupings_1.groupings_8.livestock_kept.other","groupings_1.groupings_8.livestock_kept.consent_to_ask_not_given","groupings_1.groupings_8.other_livestock_kept","groupings_1.groupings_8.previous_livestock","groupings_1.groupings_8.previous_livestock.none","groupings_1.groupings_8.previous_livestock.dairy_cattle","groupings_1.groupings_8.previous_livestock.oxen","groupings_1.groupings_8.previous_livestock.donkey","groupings_1.groupings_8.previous_livestock.poultry","groupings_1.groupings_8.previous_livestock.goats","groupings_1.groupings_8.previous_livestock.sheep","groupings_1.groupings_8.previous_livestock.fish","groupings_1.groupings_8.previous_livestock.bees","groupings_1.groupings_8.previous_livestock.pigs","groupings_1.groupings_8.previous_livestock.rabbits","groupings_1.groupings_8.previous_livestock.quails","groupings_1.groupings_8.previous_livestock.ducks","groupings_1.groupings_8.previous_livestock.pigeon_doves","groupings_1.groupings_8.previous_livestock.other","groupings_1.groupings_8.previous_livestock.consent_to_ask_not_given","groupings_1.groupings_8.other_previous_livestock","groupings_1.groupings_8.future_livestock","groupings_1.groupings_8.future_livestock.none","groupings_1.groupings_8.future_livestock.dairy_cattle","groupings_1.groupings_8.future_livestock.oxen","groupings_1.groupings_8.future_livestock.donkey","groupings_1.groupings_8.future_livestock.poultry","groupings_1.groupings_8.future_livestock.goats","groupings_1.groupings_8.future_livestock.sheep","groupings_1.groupings_8.future_livestock.fish","groupings_1.groupings_8.future_livestock.bees","groupings_1.groupings_8.future_livestock.pigs","groupings_1.groupings_8.future_livestock.rabbits","groupings_1.groupings_8.future_livestock.quails","groupings_1.groupings_8.future_livestock.ducks","groupings_1.groupings_8.future_livestock.pigeon_doves","groupings_1.groupings_8.future_livestock.other","groupings_1.groupings_8.future_livestock.consent_to_ask_not_given","groupings_1.groupings_8.other_future_livestock","groupings_1.groupings_8.livestock_sold","groupings_1.groupings_8.livestock_sold.none","groupings_1.groupings_8.livestock_sold.dairy_cattle","groupings_1.groupings_8.livestock_sold.oxen","groupings_1.groupings_8.livestock_sold.donkey","groupings_1.groupings_8.livestock_sold.poultry","groupings_1.groupings_8.livestock_sold.goats","groupings_1.groupings_8.livestock_sold.sheep","groupings_1.groupings_8.livestock_sold.fish","groupings_1.groupings_8.livestock_sold.bees","groupings_1.groupings_8.livestock_sold.pigs","groupings_1.groupings_8.livestock_sold.rabbits","groupings_1.groupings_8.livestock_sold.quails","groupings_1.groupings_8.livestock_sold.ducks","groupings_1.groupings_8.livestock_sold.pigeon_doves","groupings_1.groupings_8.livestock_sold.other","groupings_1.groupings_8.livestock_sold.consent_to_ask_not_given","groupings_1.groupings_8.other_livestock_sold","groupings_1.groupings_8.groupings_9.livestock_market_place","groupings_1.groupings_8.groupings_9.livestock_market_place.neighbours","groupings_1.groupings_8.groupings_9.livestock_market_place.middlemen","groupings_1.groupings_8.groupings_9.livestock_market_place.contract_arrangement","groupings_1.groupings_8.groupings_9.livestock_market_place.international","groupings_1.groupings_8.groupings_9.livestock_market_place.regional","groupings_1.groupings_8.groupings_9.livestock_market_place.nairobi","groupings_1.groupings_8.groupings_9.livestock_market_place.kitale",
       "groupings_1.groupings_8.groupings_9.livestock_market_place.local","groupings_1.groupings_8.groupings_9.livestock_market_place.consent_to_ask_not_given","groupings_1.groupings_8.groupings_9.livestock_local_markets","groupings_1.groupings_8.groupings_9.groupings_10.livestock_regular_income","groupings_1.groupings_8.groupings_9.groupings_10.livestock_value_addition","groupings_1.nearest_markets","groupings_1.groupings_11.new_farming_technologies","groupings_1.groupings_11.sharing_new_technologies","groupings_1.groupings_11.improvement_in_productivity","groupings_1.groupings_15.modes_transport","groupings_1.groupings_15.modes_transport.none",
       "groupings_1.groupings_15.modes_transport.bike","groupings_1.groupings_15.modes_transport.motorbike","groupings_1.groupings_15.modes_transport.motorized_vehicle","groupings_1.groupings_15.modes_transport.consent_to_ask_not_given","groupings_1.groupings_15.group_membership","groupings_1.groupings_12.group_leadership","groupings_1.groupings_12.group_influence_agriculture","groupings_1.groupings_13.farm_labor","groupings_1.groupings_13.labour_hired_out","groupings_1.off_farm_income","groupings_1.frequency_off_farm_income","groupings_1.house_image","reason_for_no_consent","X__version__","X_id","SubmissionDate","SubmissionTime","groupings_1.groupings_5.crops_grown.white_zaporta","groupings_1.groupings_5.previous_crops.white_zaporta","groupings_1.groupings_5.future_crops.white_zaporta","groupings_1.groupings_5.crops_sold.white_zaporta","my_date","groupings_1.groupings_2.household_units","groupings_1.groupings_14.polygamy_elsewhere_farms","groupings_1.groupings_5.crops_grown.cowpeas","groupings_1.groupings_5.crops_grown.soya_beans","groupings_1.groupings_5.previous_crops.cowpeas","groupings_1.groupings_5.previous_crops.soya_beans","groupings_1.groupings_5.future_crops.cowpeas","groupings_1.groupings_5.future_crops.soya_beans","groupings_1.groupings_5.crops_sold.cowpeas","groupings_1.groupings_5.crops_sold.soya_beans","groupings_1.groupings_5.groupings_6.crop_market_place.anyone","groupings_1.groupings_8.groupings_9.livestock_market_place.anyone","gender","subject","sport","aspiration","note_3","presidents","countries.liberia","countries.mali","countries.eritrea","countries.nigeria","countries.namibia","countries.togo","countries.ghana","countries.cameroon","county.bomet","county.nairobi","county.kitale","county.nyahururu","county.turkana","county.nyeri","county.eldoret","fruits.guava","fruits.banana","fruits.groundnuts","fruits.loquats","fruits.maize","fruits.sweetpotatoe","fruits.pineapple","house_image","countries","county","fruits","V453")
#Create summary data frames
survey_by_vil <- survey %>% group_by(Village.) %>% summarise(count = n())
survey_by_vil_var <- survey %>% group_by(Village., Variety.) %>% summarise(count = n())
exp <- expand.grid(levels(survey$Village.),levels(survey$Variety.))
names(exp) <- c("Village.", "Variety.")
survey_by_vil_var <- full_join(exp, survey_by_vil_var)

#Split summary data frames
spl_vil <- split(survey_by_vil, survey_by_vil$Village.)
spl_vil_var <- split(survey_by_vil_var, survey_by_vil_var$Village.)

#Calculate summaries by split groups
for(i in 1:length(spl_vil_var)) {
  print(spl_vil_var[[i]]$count / spl_vil[[i]]$count)
}

#filters
InstatDataObject$add_filter("survey", filter_name = "Niko_Only", list(list(column = "Village.", operation = "%in%", value = "NIKO")), set_as_current_filter = TRUE)
InstatDataObject$add_filter("survey", filter_name = "YieldOver20", list(list(column = "Yield", operation = ">", value = 20000), list(column = "Size", operation = "!=", value = NA)), set_as_current_filter = TRUE)
InstatDataObject$add_filter("survey", filter_name = "YieldOver30", list(list(column = "Yield", operation = ">", value = 30)), set_as_current_filter = FALSE)
InstatDataObject$set_current_filter("survey", filter_name = "YieldOver30")
#calculations
InstatDataObject$calculate_summary("survey", c("Field", "Size"), c(max_label), c("Village."), return_output = TRUE)
InstatDataObject$calculate_summary("survey", c("Yield"), c(max_label), c("Village."), return_output = TRUE)

InstatDataObject$calculate_summary("survey", c("Yield"), c(mean_label), c("Village."), filter_names = c("no_filter", "Niko_Only", "YieldOver20", "YieldOver30"))
InstatDataObject$calculate_summary("survey", c("Field"), c(min_label), c("Village."))
#InstatDataObject$get_data_frame("survey_by_Village._Variety.", convert_to_character = TRUE, include_hidden_columns = FALSE, use_current_filter = TRUE)

InstatDataObject$get_data_names()
View(InstatDataObject$get_data_frame("survey"))
x <- InstatDataObject$get_data_frame("survey")
View(InstatDataObject$get_variables_metadata("survey_by_Village.", update = TRUE))
View(InstatDataObject$get_variables_metadata("survey_by_Village.", convert_to_character = TRUE))
View(InstatDataObject$get_combined_metadata())
 x<- c("StartDate","StartTime","EndDate","EndTime","community_id","school","data_collector","farm_id","hh_ID","GPS_Record","X_GPS_Record_latitude","X_GPS_Record_longitude","X_GPS_Record_altitude","X_GPS_Record_precision","acknowledge","Gender","Mother","children_under_2","biological_mother","caretaker_type","group_membership","leadership_position","diet_variety","diet_variety.none","diet_variety.maize","diet_variety.finger_millet","diet_variety.rice","diet_variety.cooking_banana","diet_variety.wheat","diet_variety.amaranth_seeds","diet_variety.sweet_potatoes","diet_variety.irish_potato","diet_variety.beans","diet_variety.sunflower_seed","diet_variety.omena","diet_variety.chicken","diet_variety.beef","diet_variety.kales","diet_variety.cabbage","diet_variety.spinach","diet_variety.crotolaria","diet_variety.cowpea_leaves","diet_variety.jute","diet_variety.pumpkin_leaves","diet_variety.spider_plant","diet_variety.black_nightshade",
       "antenatal_care","cooking_fuel","cooking_fuel.gas","cooking_fuel.charcoal","cooking_fuel.fuel_kerosene_paraffin","cooking_fuel.sawdust","cooking_fuel.firewood","cooking_fuel.crop_residue","cooking_fuel.other","cooking_fuel.consent_to_ask_not_given","other_cooking_fuel","securing_cooking_fuel_time","securing_water_time","primary_source_water","primary_source_water.paid_protected","primary_source_water.free_protected","primary_source_water.rain_watertank","primary_source_water.unprotected","primary_source_water.consent_to_ask_not_given","water_treatment","religion_diet_influence","reason_for_no_consent","SubmissionDate","SubmissionTime","diet_variety.usual_household_food","food_eaten_last_week.usual_household_food","children_under_two_foods.usual_household_food","pregnancy_foods.usual_household_food","pregnancy_forbidden_foods.usual_household_food","lactating_foods.usual_household_food","V503")
#objects
InstatDataObject$add_object(object = list(1,2))
InstatDataObject$add_object(object = ggplot(), object_name = "plot")
InstatDataObject$add_object("SAMRAIN", list(1,2,3,4,5), "big_numbers")
InstatDataObject$add_object("survey", ggplot(), "plot1")
InstatDataObject$add_object("survey", ggplot()+geom_bar(), "plot2")
InstatDataObject$add_object("survey", list(1,2,4), "model1")
#RunInternalScript("InstatDataObject$add_object(" & Chr(34) & survey & Chr(34) & ", ggplot(), " & Chr(34) & "plot2" & Chr(34) & ")")
i = 1
for(col in survey) {
  if(!"class" %in% names(attributes(col))) attr(col, "class") <- class(col)
  ind = which(names(attributes(col)) == "levels")
  if(length(ind) > 0) col_attributes = attributes(col)[-ind]
  else col_attributes = attributes(col)
  if(i == 1) out = col_attributes
  else out = bind_rows(out, col_attributes)
  i = i + 1
}
row.names(out) <- names(survey)

out=c()
for(i in 1:nrow(survey)) {
  out[i] = sum(survey$Village.[1:i]==survey$Village.[i])
}

for(curr_sheet in names(wb)) {
  addStyle(wb, cols = 1, rows = 1, sheet = curr_sheet, style = createStyle(), gridExpand = FALSE)
}
sapply(names(wb), function(name) addStyle(wb, cols = 1, rows = 1, sheet = name, style = createStyle(), gridExpand = FALSE))
# InstatDataObject$import_data(data_tables = list(SAMRAIN=SAMRAIN))
saveRDS(InstatDataObject, "kobo_example.RDS")
# SAMRAINObject <- readRDS("SAMRAINObject.RDS")
# InstatDataObject$import_data(data_tables = list(survey=survey))
# InstatDataObject$import_RDS(SAMRAINObject, keep_existing = FALSE)

InstatDataObject$calculate_summary("survey", "Field", c(mean_label, max_label), c("Village.", "Variety."), return_output = FALSE)
InstatDataObject$calculate_summary("survey", "Size", c(mean_label, max_label), c("Village."), return_output = FALSE)
InstatDataObject$calculate_summary("survey", "Field", c(min_label, sd_label), c("Village.", "Variety."), return_output = FALSE)
View(InstatDataObject$data_objects$`survey_by_Village.-Variety.`$data)
View(InstatDataObject$data_objects$survey_by_Village.$data)

InstatDataObject$get_variables_metadata(data_name = "survey", data_type = "all", convert_to_character = TRUE)
InstatDataObject$get_data_frame("survey", convert_to_character = FALSE)
InstatDataObject$append_to_variables_metadata("survey", "Size", display_decimal_label, 3)
InstatDataObject$append_to_dataframe_metadata("survey", is_calculated_label, TRUE)
InstatDataObject$get_combined_metadata(TRUE)

library(R6)

Person <- R6Class("Person",
                  public = list(
                    name = NA,
                    hair = NA,
                    initialize = function(name, hair) {
                      if (!missing(name)) self$name <- name
                      if (!missing(hair)) self$hair <- hair
                      self$greet()
                    },
                    set_hair = function(val,val2) {
                      initialize(val,val2)
                    },
                    greet = function() {
                      cat(paste0("Hello, my name is ", self$name, ".\n"))
                    }
                  )
)

myfunc1 <- function(dat, x, y) {
  dat[, sum(get(x)), by=y]
}

myfunc2 <- function(dat, x, y) {
  dat[, lapply(.SD,sum), by=y, .SDcol=x]
}

View(InstatDataObject$data_objects[[1]]$data)

levels(InstatDataObject$data_objects[[1]]$data$Village.)

sapply(levels(survey$Village.)[-which(levels(survey$Village.)=="KESEN")], function(x) ifelse(survey$Village.==x, 1, 0))

tes <- function(a, b) {
  if(b==1) a = 1
  print(missing(a))
}
abc
   
bungoma <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/Bungoma_2.csv")
kakamega <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/Kakamega_2.csv")
bungoma$Year1 <- factor(bungoma$Year)
kenya_obj = instat_obj$new(data_tables = list(bungoma = bungoma, kakamega = kakamega))
#View(kenya_obj$data_objects$bungoma$data)

#View(bungoma_data_obj$variable_metadata)


SAMRAIN <- read.csv("C:/Users/Danny/Google Drive/African Maths Initiative/0. Initiatives/4. Climate Data Work/Data/SAMRAIN.csv", header=TRUE)
kenya_obj = instat_obj$new(data_tables = list(SAMRAIN = SAMRAIN))
SAMRAIN_temp <- kenya_obj$get_data_frame(data_name="SAMRAIN")
Samrain_stacked <- melt(variable.name="Variable", value.name="Value", data=SAMRAIN_temp, measure.vars="Strt1", id.vars="Year")
kenya_obj$import_data(data_tables = list(Samrain_stacked = Samrain_stacked))


# data selector for selecting data frame
# options sub dialogue
# r syntax
# opening/saving
# opening large data set
# rsetup - only source files
# loaddata - create Instat object
# add name option for filling grid from list of data frames


test1 = function(b) {
  test2(b)
}

test2 = function(b) {
  if(missing(b)) 2
}